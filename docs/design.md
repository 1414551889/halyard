```
 _           _                     _
| |__   __ _| |_   _  __ _ _ __ __| |
| '_ \ / _` | | | | |/ _` | '__/ _` |
| | | | (_| | | |_| | (_| | | | (_| |
|_| |_|\__,_|_|\__, |\__,_|_|  \__,_|
               |___/
```

This document is made of two key sections, and we recommend reading them in
order.

- [Architecture](#architecture)

- [Goals and Solutions](#goals-and-solutions)

# Architecture

In order to understand how Halyard will tackle the problems we will describe
below, it is valuable to have a mental model of how it will be architected.

Halyard itself will be a daemon listening to requests on port
8064<sub>[1](#footnotes)</sub>, the content of those requests will be generated by a
user-friendly interface (either a web UI or CLI), which will be described in a
separate document.

# Goals and Solutions

Currently, it is not easy to setup and operate non-trivial installations of
[Spinnaker](https://github.com/spinnaker/spinnaker). It requires knowledge of
the behavior and operation of many independently configured services - and even
with that knowledge - there is no existing solution for distributing or
valdating configuration, updating Spinnaker's stateful services, or interacting
with Spinnaker's API outside of the prebuilt UI. The goal of Halyard
is to provide a solution for all of this. To understand what Halyard will
become, and how it will address these problems, we will separate the
concerns of Halyard into three stages.

- 1) [Configuring Spinnaker](#1-configuring-spinnaker)

- 2) [Deploying and Updating Spinnaker](#2-deploying-and-updating-spinnaker)

- 3) [Operating the Spinnaker API](#3-operating-the-spinnaker-api)

## 1) Configuring Spinnaker

The first stage in Halyards development will involve three parts.

- 1.1) [Versioning Spinnaker](#11-versioning-spinnaker)

- 1.2) [Distributing Authoritative
   Configuration](#12-distributing-authoritative-configuration)

- 1.3) [Generating User Configuration](#13-generating-user-configuration)

  - [`~/.hal` Contents](#hal-contents)

  - [`~/.hal` Semantics](#hal-semantics)

  - [Halyard Interface](#halyard-interface)

### 1.1) Versioning Spinnaker

In order to have confidence in the Spinnaker installation being deployed, we
need to pin specific versions of Spinnaker microservices, as well as the
dependencies they require. We propose that the schema looks as follows:

```yaml
version: 1.4.0
services:                   # one entry for every service
  clouddriver:
    version: 1.320.0        # corresponds to travis-ci spinnaker release
    dependencies:           # list of name/version pairs
      - name: redis
        version: >2.0       # it is worth exploring version ranges here
  orca: ...
```

While the first iteration of Halyard development (configuring Spinnaker) will
not be able to deploy Spinnaker with the specified versions, it is important
that we pin sets of Spinnaker configuration to sets of Spinnaker service
versions by means of a holistic version number (HVN).

This version file should never need to exist on any machine deploying or
running Spinnaker, as it only needs to be readable by Halyard at
deployment/configuration time, meaning it could be hosted at a publicly
readable web endpoint. However, the HVN itself will be present on whatever
machine is running Halyard to inform it of what configuration to read and what
to deploy.

### 1.2) Distributing Authoritative Configuration

The idea is to have a single place that shared, authoritative Spinnaker
configuration can be downloaded from. This will ultimately replace the
configuration in
[spinnaker/config](https://github.com/spinnaker/spinnaker/tree/master/config)
by storing each `*.yaml` file in a single versioned bucket. The bucket version
will be mapped to Spinnaker HVNs to make it simple for Halyard to fetch the
correct configuration. The actual set of configuration will never need to be
stored on the maching running Halyard, only staged there during distribution
of the configuration.

### 1.3) Generating User Configuration

This will be the most challenging part of Halyard's first phase of development.
In order to do this correctly, let's first list some goals:

- a) The user should never have to open a text editor to write or edit
  Spinnaker confiuration

- b) If the user does want to hand-edit configuration, Halyard should not
  interfere with that (but it will be an advanced use-case, and shall be
  treated as such).

- c) Halyard should enable a user to configure multiple instances of Spinnaker
  all from the same machine.

- d) It should be easy to extend Halyard to accept new config options.

To achieve these goals, Halyard will take a two-step approach to generating
Spinnaker configuration:

- a) Receive a number of user commands (add an account, add a trigger, etc...)
  and store the resulting output in the `~/.hal/config` file.

- b) Reading configuration from `~/.hal/config` and from the specified HVN,
  write out all Spinnaker configuration to `~/.spinnaker` (the default
  configuration directory).

Before exploring the semantics of the individual Halyard commands, let's look
at the `~/.hal` directory.

#### `~/.hal` Contents

The directory structure will look something like this:

```
.hal/
  config                     # all halyard spinnaker entries
  my-spinnaker-1/            # optional directory with per-install overrides
    clouddriver-local.yaml   # optional -<profile>.yaml files with overrides
  my-spinnaker-2/
    igor-local.yaml
    echo-local.yaml
```

The takeaway for the above diagram is that only `~/.hal/config` is required,
and that for each installation of Spinnaker you can optionally
provide your own `*-<profile>.yaml` files for further configuration.

The contents of `~/.hal/config` will look like this:

```yaml
halyard-version: 1.0.0
current-deployment: my-spinnaker-1     # which deployment to operate on
deployment-configuration:
  - name: my-spinnaker-1
    version: 1.4.0                     # HVN
    providers:
      kubernetes:                      # provider-specific details
        enabled: true
        accounts:
          - name: my-kubernetes-account
            context: ...
          - name: my-other-kubernetes-account
      google:
        enabled: false
        accounts:
          - name: ...
    webhooks:                          # not the best name, TODO
      jenkins:                         # CI-specific details
        enabled: true
        accounts:
          - name: cloudbees
            address: ...
  - name: my-spinnaker-2
    accounts: ...
```

These fields will map to entries in each service's config by means of a global
key-value map, read by Halyard at start time. The purpose of this is to allow
non-Halyard developers to add parseable entries to `~/.hal/config` without
searching through code. For example, the above entries would be mapped like so:

```yaml
providers.kubernetes:
  services:                # we can map a value to multiple services
    - name: clouddriver
      entries:
        - kubernetes       # notice this substitutes a whole nested dictionary
providers.google:
  services:
    - name: clouddriver
      entries:
        - google
webhooks.jenkins:
  services:
    - name: igor
      entries:
        - jenkins
```

The benefit to this approach is that any entry to one of the already configured
key/value pairs above does not need a change in Halyard to be surfaced.
Furthermore, a change that is not captured in that above example will likely
no more than 5 lines of YAML.

#### `~/.hal` Semantics

Now that we know what will be stored in the `~/.hal` directory, we need to
explain how to generate the contents of the `~/.spinnaker` directory.

- i) For the current deployment, Halyard will download all configuration for
  the given version number.

- ii) Halyard will parse the specified entry in `~/.hal/config` as well as all
  `*-<profile>.yaml` files in the directory of the given entry. Any values
  specified in a `*-<profile>.yaml` file will override the corresponding entry
  in `~/.hal/config`, but only at the level of key/literal value pairs. This
  means duplicate dictionaries will be merged, overwriting entries only when
  they map to a string, integer, or boolean.

- iii) Once all substitutions have occured, all configuration (downloaded and
  overwritten) is dumped into `~/.spinnaker`. It is important to note that
  Halyard treats a missing `-local` profile as an empty `-local` profile, so
  ultimately all the contents of `~/.hal/config` are written somewhere.

---

Notice that so far we have just defined a more general `spinnaker-local.yaml`,
which alone is not interesting. However, this allows us to make the full set of
config changes available to Spinnaker, which are also interesting and useful to
a user of Spinnaker.

#### Halyard Interface

Halyard will only ever make changes to `~/.hal/config`, leaving it up to the
user to make optional changes to `~/.hal/<spinnaker-deployment>/*`. This should
be clear from the above reading. Below is a list of HTTP actions to be taken
against the Halyard daemon by a client.

| ACTION   | PATH `/<version>/<deployment>/<type>/<name>` | BODY | DESCRIPTION |
|----------|----------------------------------------------|------|-------------|
| `POST`   | `/accounts` | account description | create new account |
| `POST`   | `/webhooks` | webhook description | create new webhook |
| `PUT`    | `/enabled` | boolean | enable/disable account |
| `PUT`    | `/enabled` | boolean | enable/disable webhook |
| `PUT`    | `/accounts/<account>` | account description | edit account |
| `PUT`    | `/webhooks/<webhook>` | account description | edit webhook |
| `DELETE` | `/accounts/<account>` | | delete account |
| `DELETE` | `/webhooks/<webhook>` | | delete webhook |
| `GET`    | `*` | | return everything matching this path |

> `<version>`: Halyard version.
>
> `<deployment>`: Name of the spinnaker deployment.
>
> `<type>`: (`provider`|`webhook`|`git`).
>
> `<name>`: name of `provider`, `webhook`, or `git` entry.

Once an incoming change has been processed, the resulting config will always be
run through a validator to ensure that Spinnaker can still be deployed with 
what's been provided. If the validator passes, the configuration is written out 
to `~/.spinnaker`, as described above. If it fails, the operation will be 
rejected with an error message describing why.

## 2. Deploying and Updating Spinnaker

TODO

## 3. Operating the Spinnaker API

TODO

---

#### Footnotes

[1] 9th factorial divided by the 9th triangle number. Also happens to be an
unassigned port close to the range used by other Spinnaker services.
